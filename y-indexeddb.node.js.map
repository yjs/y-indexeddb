{"version":3,"file":"y-indexeddb.node.js","sources":["src/y-indexeddb.js"],"sourcesContent":["/* global indexedDB, location, BroadcastChannel */\n\n/*\n * Request to Promise transformer\n */\nfunction rtop (request) {\n  return new Promise(function (resolve, reject) {\n    request.onerror = function (event) {\n      reject(new Error(event.target.error))\n    }\n    request.onblocked = function () {\n      location.reload()\n    }\n    request.onsuccess = function (event) {\n      resolve(event.target.result)\n    }\n  })\n}\n\nfunction openDB (room) {\n  return new Promise(function (resolve, reject) {\n    let request = indexedDB.open(room)\n    window.r1 = request\n    request.onupgradeneeded = function (event) {\n      const db = event.target.result\n      if (db.objectStoreNames.contains('model')) {\n        db.deleteObjectStore('updates')\n        db.deleteObjectStore('model')\n        db.deleteObjectStore('custom')\n      }\n      db.createObjectStore('updates', {autoIncrement: true})\n      db.createObjectStore('model')\n      db.createObjectStore('custom')\n    }\n    request.onerror = function (event) {\n      reject(new Error(event.target.error))\n    }\n    request.onblocked = function () {\n      location.reload()\n    }\n    request.onsuccess = function (event) {\n      const db = event.target.result\n      db.onversionchange = function () { db.close() }\n      resolve(db)\n    }\n  })\n}\n\nconst PREFERRED_TRIM_SIZE = 500\n\nexport default function extendYIndexedDBPersistence (Y) {\n  class IndexedDBPersistence extends Y.AbstractPersistence {\n    constructor (opts) {\n      super(opts)\n      window.addEventListener('unload', () => {\n        this.ys.forEach(function (cnf, y) {\n          if (cnf.db !== null) {\n            cnf.db.close()\n          } else {\n            cnf._db.then(db => db.close())\n          }\n        })\n      })\n    }\n    init (y) {\n      let cnf = this.ys.get(y)\n      let room = y.room\n      cnf.db = null\n      const dbOpened = openDB(room)\n      dbOpened.then(db => {\n        cnf.db = db\n      })\n      if (typeof BroadcastChannel !== 'undefined') {\n        cnf.channel = new BroadcastChannel('__yjs__' + room)\n        cnf.channel.addEventListener('message', e => {\n          cnf.mutualExcluse(function () {\n            y.transact(function () {\n              Y.utils.integrateRemoteStructs(y, new Y.utils.BinaryDecoder(e.data))\n            })\n          })\n        })\n      } else {\n        cnf.channel = null\n      }\n      var token = true\n      cnf.mutualExcluse = function (f) {\n        if (token) {\n          token = false\n          try {\n            f()\n          } catch (e) {\n            token = true\n            throw new Error(e)\n          }\n          token = true\n        }\n      }\n      return dbOpened\n    }\n\n    deinit (y) {\n      let cnf = this.ys.get(y)\n      cnf.db.close()\n      super.deinit(y)\n    }\n\n    set (y, key, value) {\n      const cnf = this.ys.get(y)\n      const t = cnf.db.transaction(['custom'], 'readwrite')\n      const customStore = t.objectStore('custom')\n      return rtop(customStore.put(value, key))\n    }\n\n    get (y, key) {\n      const cnf = this.ys.get(y)\n      const t = cnf.db.transaction(['custom'], 'readwrite')\n      const customStore = t.objectStore('custom')\n      return rtop(customStore.get(key))\n    }\n\n    /**\n     * Remove all persisted data that belongs to a room.\n     * Automatically destroys all Yjs all Yjs instances that persist to\n     * the room. If `destroyYjsInstances = false` the persistence functionality\n     * will be removed from the Yjs instances.\n     */\n    removePersistedData (room, destroyYjsInstances = true) {\n      super.removePersistedData(room, destroyYjsInstances)\n      return rtop(indexedDB.deleteDatabase(room))\n    }\n\n    saveUpdate (y, update) {\n      let cnf = this.ys.get(y)\n      if (cnf.channel !== null) {\n        cnf.channel.postMessage(update)\n      }\n      let t = cnf.db.transaction(['updates'], 'readwrite')\n      let updatesStore = t.objectStore('updates')\n      updatesStore.put(update)\n      let cntP = rtop(updatesStore.count())\n      cntP.then(cnt => {\n        if (cnt >= PREFERRED_TRIM_SIZE) {\n          this.persist(y)\n        }\n      })\n    }\n\n    saveStruct (y, struct) {\n      let cnf = this.ys.get(y)\n      cnf.mutualExcluse(() => {\n        super.saveStruct(y, struct)\n      })\n    }\n\n    retrieve (y) {\n      let cnf = this.ys.get(y)\n      let t = cnf.db.transaction(['updates', 'model'], 'readonly')\n      let modelStore = t.objectStore('model')\n      let updatesStore = t.objectStore('updates')\n      return Promise.all([rtop(modelStore.get(0)), rtop(updatesStore.getAll())])\n        .then(([model, updates]) => {\n          cnf.mutualExcluse(() => {\n            super.retrieve(y, model, updates)\n          })\n        })\n    }\n\n    persist (y) {\n      let cnf = this.ys.get(y)\n      let db = cnf.db\n      let t = db.transaction(['updates', 'model'], 'readwrite')\n      let updatesStore = t.objectStore('updates')\n      return rtop(updatesStore.getAll())\n      .then(updates => {\n        // apply pending updates before deleting them\n        Y.AbstractPersistence.prototype.retrieve.call(this, y, null, updates)\n        // get binary model\n        let binaryModel = Y.AbstractPersistence.prototype.persist.call(this, y)\n        // delete all pending updates\n        if (updates.length > 0) {\n          let modelStore = t.objectStore('model')\n          modelStore.put(binaryModel, 0)\n          updatesStore.clear()\n        }\n      })\n    }\n  }\n  Y.IndexedDB = IndexedDBPersistence\n  return IndexedDBPersistence\n}\n\nif (typeof Y !== 'undefined') {\n  extendYIndexedDBPersistence(Y) // eslint-disable-line\n}\n"],"names":[],"mappings":"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"}